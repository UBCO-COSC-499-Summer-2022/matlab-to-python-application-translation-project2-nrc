import numpy as np
from nrcemt.alignment_software.engine.optimization import (
    normalize_marker_data,
    optimize_particle_model,
)


def test_optimize_particle_model():
    normalized_markers = normalize_marker_data(markers)
    tilt = np.arange(61) * 3
    x, y, z, alpha, phai = optimize_particle_model(normalized_markers, tilt)
    np.testing.assert_allclose(x, [
        -33.9940, -119.2370, 12.1170, 64.8145, 76.2996
    ], rtol=1e-4)
    np.testing.assert_allclose(y, [
        236.3193, 110.7438, -135.3844, 21.7134, -233.3922,
    ], rtol=1e-4)
    np.testing.assert_allclose(z, [
        -74.9492, -29.2715, 30.8413, -32.2439, 105.6234,
    ], rtol=1e-4)
    np.testing.assert_allclose([alpha, phai], [2.8963, -0.2604], rtol=1e-4)


# get rid of this later and load from file
markers = np.array(
    [
        [
            [534, 851],
            [529, 850],
            [519, 850],
            [509, 850],
            [499, 852],
            [490, 852],
            [481, 851],
            [475, 852],
            [467, 850],
            [461, 851],
            [452, 852],
            [446, 851],
            [439, 851],
            [433, 853],
            [427, 852],
            [423, 852],
            [414, 850],
            [408, 851],
            [404, 852],
            [399, 853],
            [393, 852],
            [388, 851],
            [385, 852],
            [379, 851],
            [377, 850],
            [374, 849],
            [373, 849],
            [371, 851],
            [372, 849],
            [368, 848],
            [368, 847],
            [369, 846],
            [372, 846],
            [378, 844],
            [378, 847],
            [381, 847],
            [384, 846],
            [388, 846],
            [395, 845],
            [398, 845],
            [404, 844],
            [408, 845],
            [417, 844],
            [424, 844],
            [433, 842],
            [442, 843],
            [450, 843],
            [459, 843],
            [469, 842],
            [475, 842],
            [486, 842],
            [497, 842],
            [509, 842],
            [519, 841],
            [531, 841],
            [542, 840],
            [555, 839],
            [566, 838],
            [576, 837],
            [586, 837],
            [598, 838],
        ],
        [
            [443, 726],
            [440, 726],
            [433, 727],
            [426, 728],
            [420, 728],
            [412, 728],
            [408, 728],
            [405, 728],
            [400, 728],
            [398, 727],
            [394, 727],
            [392, 728],
            [390, 728],
            [389, 729],
            [388, 729],
            [387, 728],
            [386, 728],
            [384, 728],
            [383, 728],
            [383, 729],
            [384, 729],
            [384, 729],
            [386, 727],
            [387, 724],
            [388, 722],
            [390, 723],
            [391, 722],
            [394, 725],
            [399, 723],
            [403, 723],
            [407, 722],
            [412, 721],
            [418, 718],
            [427, 718],
            [433, 718],
            [441, 718],
            [446, 716],
            [455, 716],
            [463, 715],
            [472, 717],
            [478, 716],
            [487, 716],
            [499, 715],
            [508, 715],
            [519, 714],
            [528, 713],
            [538, 714],
            [548, 713],
            [558, 713],
            [565, 713],
            [576, 712],
            [587, 710],
            [599, 711],
            [608, 710],
            [619, 709],
            [630, 709],
            [640, 708],
            [650, 708],
            [658, 707],
            [666, 707],
            [676, 706],
        ],
        [
            [563, 476],
            [562, 476],
            [557, 476],
            [552, 475],
            [548, 476],
            [542, 476],
            [538, 476],
            [535, 476],
            [532, 475],
            [528, 475],
            [524, 475],
            [521, 475],
            [517, 475],
            [515, 474],
            [510, 474],
            [507, 473],
            [504, 473],
            [499, 473],
            [496, 475],
            [491, 476],
            [486, 476],
            [484, 476],
            [480, 477],
            [475, 477],
            [472, 475],
            [470, 474],
            [466, 474],
            [463, 474],
            [457, 473],
            [456, 473],
            [455, 472],
            [455, 471],
            [454, 470],
            [452, 469],
            [450, 470],
            [449, 470],
            [449, 468],
            [451, 469],
            [453, 469],
            [452, 470],
            [454, 470],
            [454, 470],
            [459, 469],
            [458, 468],
            [461, 468],
            [463, 468],
            [465, 469],
            [470, 468],
            [473, 467],
            [475, 468],
            [479, 468],
            [484, 468],
            [489, 468],
            [494, 468],
            [500, 467],
            [505, 469],
            [511, 467],
            [516, 467],
            [520, 467],
            [525, 467],
            [531, 466],
        ],
        [
            [623, 631],
            [618, 631],
            [612, 632],
            [602, 632],
            [595, 631],
            [585, 632],
            [577, 632],
            [570, 632],
            [563, 632],
            [557, 632],
            [547, 632],
            [539, 632],
            [531, 633],
            [524, 632],
            [516, 633],
            [508, 632],
            [501, 632],
            [491, 632],
            [485, 634],
            [475, 634],
            [464, 632],
            [459, 633],
            [452, 633],
            [443, 632],
            [438, 630],
            [431, 630],
            [426, 632],
            [418, 634],
            [412, 632],
            [404, 631],
            [400, 630],
            [398, 630],
            [394, 629],
            [390, 630],
            [387, 630],
            [384, 631],
            [381, 630],
            [381, 630],
            [382, 630],
            [382, 631],
            [380, 632],
            [380, 631],
            [383, 631],
            [384, 630],
            [388, 631],
            [390, 629],
            [394, 630],
            [398, 630],
            [403, 630],
            [404, 629],
            [409, 630],
            [415, 629],
            [423, 628],
            [430, 629],
            [439, 628],
            [446, 628],
            [455, 628],
            [463, 627],
            [471, 627],
            [479, 627],
            [487, 626],
        ],
        [
            [623, 372],
            [622, 372],
            [622, 373],
            [622, 372],
            [621, 372],
            [618, 373],
            [616, 372],
            [617, 372],
            [615, 371],
            [613, 372],
            [610, 371],
            [608, 372],
            [605, 370],
            [603, 371],
            [600, 371],
            [598, 370],
            [595, 370],
            [592, 371],
            [588, 372],
            [583, 371],
            [580, 375],
            [577, 374],
            [571, 375],
            [567, 380],
            [560, 373],
            [554, 375],
            [549, 375],
            [542, 374],
            [535, 373],
            [530, 374],
            [524, 372],
            [519, 373],
            [514, 370],
            [508, 373],
            [503, 370],
            [498, 370],
            [492, 369],
            [492, 368],
            [491, 368],
            [487, 368],
            [483, 368],
            [478, 368],
            [477, 368],
            [472, 368],
            [471, 368],
            [466, 368],
            [462, 368],
            [460, 369],
            [458, 368],
            [455, 369],
            [455, 370],
            [455, 370],
            [456, 370],
            [455, 370],
            [455, 369],
            [455, 370],
            [456, 370],
            [458, 370],
            [458, 370],
            [458, 370],
            [461, 369],
        ],
    ]
)
